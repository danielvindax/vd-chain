version: '3'
services:
  kafka:
    image: blacktop/kafka:2.6
    ports:
      - 127.0.0.1:29092:9092
    environment:
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_CREATE_TOPICS:
        "to-ender:1:1,\
        to-vulcan:1:1,\
        to-websockets-orderbooks:1:1,\
        to-websockets-subaccounts:1:1,\
        to-websockets-trades:1:1,\
        to-websockets-markets:1:1,\
        to-websockets-candles:1:1,\
        to-websockets-block-height:1:1"
      KAFKA_LISTENERS: INTERNAL://:9092,EXTERNAL_SAME_HOST://:29092
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:9092,EXTERNAL_SAME_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL_SAME_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server 127.0.0.1:9092 --topic to-websockets-candles --describe"]
      interval: 5s
      timeout: 20s
      retries: 50
  postgres:
    build:
      context: .
      dockerfile: Dockerfile.postgres.local
    ports:
      - 5435:5432
    environment:
      POSTGRES_PASSWORD: dydxserver123
      POSTGRES_USER: dydx_dev
      DATADOG_POSTGRES_PASSWORD: dydxserver123
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dydx_dev"]
      interval: 5s
      timeout: 20s
      retries: 10
  redis:
    image: redis:5.0.6-alpine
    ports:
      - 6382:6379
  postgres-package:
    build:
      context: .
      dockerfile: Dockerfile.postgres-package.local
    links:
      - postgres
    depends_on:
      postgres:
        condition: service_healthy
  ender:
    build:
      context: .
      dockerfile: Dockerfile.service.local
      args:
        service: ender
    ports:
      - 3001:3001
      - 9101:9101  # Metrics port
    links:
      - postgres
    environment:
      - REDIS_URL=redis://redis:6379
      # In-network Kafka broker
      - KAFKA_BROKER_URLS=kafka:9092
      # In-network Postgres (inside Docker use service name and container port)
      - DB_HOSTNAME=postgres
      - DB_READONLY_HOSTNAME=postgres
      - DB_PORT=5432
    depends_on:
      kafka:
        condition: service_healthy
      postgres-package:
        condition: service_completed_successfully
  comlink:
    build:
      context: .
      dockerfile: Dockerfile.service.local
      args:
        service: comlink
    environment:
      - REDIS_URL=redis://redis:6379
      - REDIS_READONLY_URL=redis://redis:6379
      - RATE_LIMIT_REDIS_URL=redis://redis:6379
      - PORT=3002
      - RATE_LIMIT_ENABLED=false
      - INDEXER_LEVEL_GEOBLOCKING_ENABLED=false
      - EXPOSE_SET_COMPLIANCE_ENDPOINT=true
      - COMPLIANCE_DATA_CLIENT=BLOCKLIST
      - BLOCKED_ADDRESSES=
      # In-network Postgres (inside Docker use service name and container port)
      - DB_HOSTNAME=postgres
      - DB_READONLY_HOSTNAME=postgres
      - DB_PORT=5432
    ports:
      - 3002:3002
    links:
      - postgres
    depends_on:
      postgres-package:
        condition: service_completed_successfully
  socks:
    build:
      context: .
      dockerfile: Dockerfile.service.local
      args:
        service: socks
    ports:
      - 3003:3003
      - 9104:9104  # Metrics port
    links:
      - postgres
    environment:
      - WS_PORT=3003
      - COMLINK_URL=comlink:3002
    depends_on:
      kafka:
        condition: service_healthy
      postgres-package:
        condition: service_completed_successfully
  roundtable:
    build:
      context: .
      dockerfile: Dockerfile.service.local
      args:
        service: roundtable
    ports:
      - 3004:3004
      - 9103:9103  # Metrics port
    links:
      - postgres
    environment:
      # In-network Redis & Kafka endpoints (do not use host localhost)
      - REDIS_URL=redis://redis:6379
      - REDIS_READONLY_URL=redis://redis:6379
      - KAFKA_BROKER_URLS=kafka:9092
      # In-network Postgres (inside Docker use service name and container port)
      - DB_HOSTNAME=postgres
      - DB_READONLY_HOSTNAME=postgres
      - DB_PORT=5432
      # Stub AWS config for local development to satisfy required envs
      - AWS_ACCOUNT_ID=000000000000
      - AWS_REGION=local
      - S3_BUCKET_ARN=arn:aws:s3:::local-indexer
      - ECS_TASK_ROLE_ARN=arn:aws:iam::000000000000:role/local-indexer-role
      - KMS_KEY_ARN=arn:aws:kms:local:000000000000:key/local-indexer-key
      - RDS_INSTANCE_NAME=local-indexer-rds
    depends_on:
      kafka:
        condition: service_healthy
      postgres-package:
        condition: service_completed_successfully
  vulcan:
    build:
      context: .
      dockerfile: Dockerfile.service.local
      args:
        service: vulcan
    ports:
      - 9102:9102  # Metrics port
    environment:
      - REDIS_URL=redis://redis:6379
      - REDIS_READONLY_URL=redis://redis:6379
      # In-network Kafka broker
      - KAFKA_BROKER_URLS=kafka:9092
      # In-network Postgres (inside Docker use service name and container port)
      - DB_HOSTNAME=postgres
      - DB_READONLY_HOSTNAME=postgres
      - DB_PORT=5432
    depends_on:
      kafka:
        condition: service_healthy
  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - 9090:9090
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus/alerts:/etc/prometheus/alerts
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - default
    depends_on:
      - redis_exporter
      - postgres_exporter
      - comlink
      - socks
      - ender
      - vulcan
      - roundtable
      - alertmanager

  # Alertmanager
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    ports:
      - 9093:9093
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - alertmanager_data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9093'
    networks:
      - default
    depends_on:
      - prometheus

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - 3000:3000
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    networks:
      - default
    depends_on:
      - prometheus

  # Redis Exporter
  redis_exporter:
    image: oliver006/redis_exporter:latest
    container_name: redis_exporter
    ports:
      - 9121:9121
    environment:
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
    networks:
      - default
    depends_on:
      - redis

  # Postgres Exporter
  postgres_exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres_exporter
    ports:
      - 9187:9187
    environment:
      - DATA_SOURCE_NAME=postgresql://dydx_dev:dydxserver123@postgres:5432/postgres?sslmode=disable
    networks:
      - default
    depends_on:
      - postgres

  # Loki for log aggregation
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - 3100:3100
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yaml
      - loki_data:/loki
    networks:
      - default

  # Promtail for log collection
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yml
    networks:
      - default
    depends_on:
      - loki

volumes:
  prometheus_data:
  grafana_data:
  loki_data:
  alertmanager_data:

networks:
  default:
    driver: bridge
